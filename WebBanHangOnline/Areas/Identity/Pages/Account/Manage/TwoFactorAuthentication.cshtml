@page
@using Microsoft.AspNetCore.Http.Features
@model TwoFactorAuthenticationModel
@{
    ViewData["Title"] = "Xác thực hai bước (2FA)";
    ViewData["ActivePage"] = ManageNavPages.TwoFactorAuthentication;
}

<partial name="_StatusMessage" for="StatusMessage" />

<h3>@ViewData["Title"]</h3>

@{
    var consentFeature = HttpContext.Features.Get<ITrackingConsentFeature>();
}

@if (!(consentFeature?.CanTrack ?? true))
{
    <div class="alert alert-danger">
        <strong>⚠ Chưa chấp nhận chính sách Cookie</strong>
        <p>Bạn cần chấp nhận chính sách quyền riêng tư để sử dụng xác thực hai bước.</p>
    </div>
}
else
{
    @* ===== TRẠNG THÁI 2FA ===== *@
    @if (Model.Is2faEnabled)
    {
        <div class="alert alert-success">
            <strong>✅ Xác thực hai bước đang được bật</strong>
        </div>

        @if (Model.RecoveryCodesLeft == 0)
        {
            <div class="alert alert-danger">
                <strong>Bạn đã hết mã khôi phục.</strong>
                <p>
                    Vui lòng
                    <a asp-page="./GenerateRecoveryCodes">tạo bộ mã khôi phục mới</a>
                    để tránh mất quyền truy cập.
                </p>
            </div>
        }
        else if (Model.RecoveryCodesLeft <= 3)
        {
            <div class="alert alert-warning">
                <strong>Còn @Model.RecoveryCodesLeft mã khôi phục.</strong>
                <p>
                    Bạn nên
                    <a asp-page="./GenerateRecoveryCodes">tạo mã mới</a>
                    để đảm bảo an toàn.
                </p>
            </div>
        }

        <div class="mb-3">
            @if (Model.IsMachineRemembered)
            {
                <form method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-secondary">
                        Quên trình duyệt này
                    </button>
                </form>
            }

            <a asp-page="./Disable2fa" class="btn btn-outline-danger ms-2">
                Tắt 2FA
            </a>

            <a asp-page="./GenerateRecoveryCodes" class="btn btn-outline-primary ms-2">
                Đặt lại mã khôi phục
            </a>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <strong>⚠ Xác thực hai bước chưa được bật</strong>
            <p>Bật 2FA để tăng cường bảo mật cho tài khoản của bạn.</p>
        </div>
    }

    @* ===== AUTHENTICATOR ===== *@
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Ứng dụng xác thực</h5>

            @if (!Model.HasAuthenticator)
            {
                <p class="text-muted">
                    Bạn chưa cấu hình ứng dụng xác thực.
                </p>
                <a asp-page="./EnableAuthenticator" class="btn btn-primary">
                    Thêm ứng dụng xác thực
                </a>
            }
            else
            {
                <p class="text-muted">
                    Ứng dụng xác thực đã được liên kết.
                </p>

                <a asp-page="./EnableAuthenticator" class="btn btn-outline-primary">
                    Cấu hình lại
                </a>

                <a asp-page="./ResetAuthenticator" class="btn btn-outline-danger ms-2">
                    Đặt lại Authenticator
                </a>
            }
        </div>
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
